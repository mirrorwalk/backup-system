#!/usr/bin/env bash

AUTO_CONFIRM=false
if [[ "$1" == "-y" ]]; then
    AUTO_CONFIRM=true
elif [[ "$1" == "-h" ]]; then
    echo "Usage: $0 [-y]"
    echo "  -y    Auto-confirm all prompts"
    exit 0
fi

# List of repos to back up
REPOS=(
    "$HOME/.config/nvim"
    "$HOME/.config/nixos-private"
    "$HOME/.config/nixos"
    "$HOME/.config"
)

for repo in "${REPOS[@]}"; do
    echo
    echo "=== Processing $repo ==="

    if [ ! -d "$repo/.git" ]; then
        echo "No git repo found in $repo, skipping..."
        continue
    fi

    cd "$repo" || continue

    git fetch origin &>/dev/null

    if git diff --quiet && git diff --cached --quiet && git status -uno | grep -q "up to date"; then
        echo "$repo is already up to date, skipping."
        continue
    fi

    if [ "$AUTO_CONFIRM" = false ]; then
        echo "--- Git status ---"
        git status
        echo "--- Git diff ---"
        git diff
    fi

    if [ "$AUTO_CONFIRM" = true ]; then
        git add .
        COMMIT_MSG="Backup: $(date +%s)"
        git commit -m "$COMMIT_MSG"
        git push
        echo "Auto-pushed $repo"
    else
        read -p "Commit and push changes in $repo? (y/N): " choice
        if [[ "$choice" =~ ^[Yy]$ ]]; then
            git add .
            COMMIT_MSG="Backup: $(date +%s)"
            git commit -m "$COMMIT_MSG"
            git push
        else
            echo "Skipped $repo"
        fi
    fi
done
